<html>
<head>
	<script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>
	<script src="paper-full.js"></script>
	<style>
		body{
			width:1600px;
		}
		canvas{
			border:1px solid #999;
		}
		body > div{
			display:inline-block;
			vertical-align:top;
		}
		body > div:first-child{
			width:260px;
		}
		path{
			stroke:#000;
			stroke-width:5px;
			fill:none;

		}
		table{
			border:0px solid #999;
			font-size:10px;
		}
		td{
			min-width:20px;
			min-height:20px;
			cursor:pointer;
		}
		#table4{
			width:900px;
		}
		#table4 td{
			display:inline-block;
			margin:1px;
		}
		#table3{
			padding-left:14px;
		}
		#table3 td{
			cursor:default !important;
		}
		#table2 td{
			background:#f88;
		}
		#table2 td.done, #table4 td{
			background:#8f8;
		}
		#table1 td:hover, #table2 td:hover, #table4 td:hover{
			background:#5bf;
			outline:2px solid #09e;
		}
		td.flagged{
			background:#f90 !important;
			outline:1px solid #c70
		}
		#table2 td.dead{
			background:#eee;
			outline:none;
			/*outline:1px solid #f00;*/
		}
		svg{
			vertical-align:top;
			height:20px;
			margin:auto;
		}
	</style>
</head>
<body>
	<div>
		<button onclick="undo()">undo</button>
		<button onclick="redo()">redo</button>
		<button onclick="clr()">clear</button>
		<br><br>
		<canvas id="myCanvas" width="225" height="200"></canvas>
		<br><br>
		letters (e.g., "a,b"): <input type="text" id="letters"/>
		<br><br>
		(case sensitive)
		<br><br>
		<button onclick="submit()">submit</button>
		<br><br>
		NEW (big update)
		<ul>
			<li><a href="http://azlen.github.io/perceptual-shift/?True,False">This</a>, I love it (+ you can now link to a specific word combination :D)</li>
			<li>Multiple bugfixes</li>
			<li>Flagging letters, click on a letter to flag it (flagged letters become orange). Flag letters that should be replaced.</li>
			<li>Now displays letters other than just single letters and combinations of single letters. You can now see additions like "ls,u"</li>
			<li>Check frequency of letter + double letter pairs <a href="http://azlen.github.io/perceptual-shift/frequency.html">here</a> (start with the ones with a higher number).<br><i>PS: probably innaccurate, there are definitely bugs in the algorithm, but it's fine for now</i></li>
			<li>Updates automatically when letters are changed (previously only updated letters added for the first time)</li>
			<li>Now warns you if you are replacing a letter (unless the letter has been flagged)</li>
			<li>I've been downloading backups from the server so that if something goes wrong on the server, we cannot lose everything :D</li>
		</ul>
	</div>
	<div>
		<table id="table1"></table>
		<table id="table4"><span></span></table>
		<table id="table3"></table>
		<table id="table2"></table>
	</div>
	<!--<svg id="svg">
		<path stroke="#000" stroke-width="5px" stroke-linecap="round" id="path" fill="none"/>
	</svg>-->
	<script>
		var ref = new Firebase("https://perception.firebaseio.com/");

		/*
		
		TODO
		- implement flagging in editor
		- visualize others than just singles
		- analyze most common combinations needed
		- create algorithm that is better

		*/

		var canvas = document.getElementById('myCanvas');

		var letters = document.querySelector('#letters');
		var svg = document.querySelector('#svg');

		var table1 = document.querySelector('#table1');
		var table2 = document.querySelector('#table2');
		var table3 = document.querySelector('#table3');
		var table4 = document.querySelector('#table4');

		//canvas.width =
		// Create an empty project and a view for the canvas:
		paper.setup(canvas);
		// Create a Paper.js Path to draw a line into it:
		
		/*var rect = new paper.Path.Rectangle([-1, -1], [150, 402]);
		var rect2 = new paper.Path.Rectangle([251, -1], [150, 402]);
		rect.fillColor="#eee"
		rect.strokeColor="#999"
		rect2.fillColor="#eee"
		rect2.strokeColor="#999"*/
		var line = new paper.Path.Line([0,75],[302,75])
		line.strokeColor="#999"
		line.dashArray = [10,10]
		var line = new paper.Path.Line([0,125],[302,125])
		line.strokeColor="#999"

		var line = new paper.Path.Rectangle([-1,-1],[304,26])
		line.strokeColor="#999"
		line.fillColor="#eee"
		var line = new paper.Path.Rectangle([-1,177],[304,26])
		line.strokeColor="#999"
		line.fillColor="#eee"

		var line = new paper.Path.Rectangle([75,25],[75,152])
		line.strokeColor="#f00"
		
		paper.view.update();

		var paths = []
		var undos = []

		var alphabet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'

		var mousedown = false;

		function onMouseDown(event) {
			mousedown = true;

			// Create a new path and set its stroke color to black:
			paths.push(new paper.Path({
				segments: [[event.clientX - canvas.offsetLeft + document.body.scrollLeft, event.clientY - canvas.offsetTop + document.body.scrollTop]],
				strokeColor: 'black',
				strokeWidth: 3
			}));

			undos = []
		}

		// While the user drags the mouse, points are added to the path
		// at the position of the mouse:
		function onMouseMove(event) {
			if (mousedown) {
				paths[paths.length-1].add([event.clientX - canvas.offsetLeft + document.body.scrollLeft, event.clientY - canvas.offsetTop + document.body.scrollTop]);
			}
		}

		// When the mouse is released, we simplify the path:
		function onMouseUp(event) {
			if (mousedown) {
				mousedown = false;

				var segmentCount = paths[paths.length-1].segments.length;

				// When the mouse is released, simplify it:
				paths[paths.length-1].simplify(10);
			}
		}

		function undo(){
			if(paths.length > 0){
				paths[paths.length-1].remove()
				undos.push(paths[paths.length-1])
				paths.pop()
			}
			paper.view.update()
		}

		function redo(){
			if(undos.length > 0){
				paths.push(new paper.Path({
					segments: undos[undos.length-1].getSegments(),
					strokeColor: 'black',
					strokeWidth: 3
				}));
				undos.pop()
				paper.view.update()
			}
		}

		function clr(){
			paths.forEach(function(p){
				p.remove()
			})
			paths = []
			undos = []
			paper.view.update()
		}

		function createTd(title,r,c){
			var td = document.createElement('td');
			if(r != undefined && r + 1 > c){
				td.classList.add('dead')
			}else{
				td.setAttribute('title', title)
				td.addEventListener('click', function(){
					if (td.classList.contains('flagged')) {
						ref.child('flags/'+title).remove()
					} else {
						ref.child('flags/'+title).set(1)
					}
				})
			}
			var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
			svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
			svg.setAttribute('viewBox', '75 25 75 150')
			var path = document.createElementNS("http://www.w3.org/2000/svg","path");
			svg.appendChild(path);
			td.appendChild(svg);
			return td
		}

		function updateFlag(snapshot){
			document.querySelector('*[title="'+snapshot.key()+'"]').classList.toggle('flagged')
		}

		for(var r = 0; r < 2; r++){
			var tr = document.createElement('tr');
			for(var c = 0; c < 26; c++){
				tr.appendChild(createTd(alphabet[r*26+c]))
			}
			table1.appendChild(tr)
		}

		for(var r = 0; r < 52; r++){
			var tr = document.createElement('tr');
			tr.textContent = alphabet[r]
			for(var c = 0; c < 52; c++){
				tr.appendChild(createTd(alphabet[r]+', '+alphabet[c], r, c))
			}
			table2.appendChild(tr)
		}

		var tr = document.createElement('tr');
		for(var c = 0; c < 52; c++){
			var td = document.createElement('td');
			td.textContent = alphabet[c]
			tr.appendChild(td)
		}
		table3.appendChild(tr)

		ref.child('data').on('child_added', function(snapshot){
			var k = snapshot.key().split(',').sort(function(a,b){return alphabet.indexOf(a[0]) > alphabet.indexOf(b[0])})
			var td;
			if (k.length == 1) {
				td = table1.children[(k[0].toUpperCase() == k[0])+0].children[alphabet.indexOf(k[0].toLowerCase())]
			} else if (k.join('').length == 2 && k.length == 2) {
				td = table2.children[alphabet.indexOf(k[0])].children[alphabet.indexOf(k[1])]
			}else{
				td = createTd(k.join(', '))
				table4.insertBefore(td, table4.children[0])
			}
			td.classList.add('done')
			td.querySelector('svg path').setAttribute('d', snapshot.val())
		})

		ref.child('data').on('child_changed', function(snapshot){
			console.log(snapshot.key())
			var k = snapshot.key().split(',').sort(function(a,b){return alphabet.indexOf(a[0]) > alphabet.indexOf(b[0])}).join(', ')
			console.log(k)
			document.querySelector('*[title="'+k+'"]').querySelector('svg path').setAttribute('d', snapshot.val())
		})

		function submit(){
			if (letters.value != '') {
				combpath = paths.map(function(p){return p.getPathData()}).join('')

				var key = letters.value.split(',').sort(function(a,b){return alphabet.indexOf(a[0]) > alphabet.indexOf(b[0])}).join(',')
				var el = document.querySelector('*[title="'+key.split(',').join(', ')+'"]')
				if(el && el.classList.contains('done') && !el.classList.contains('flagged')){
					if(!confirm('Are you sure you want to replace the current "'+key+'"?')){
						return
					}
				}
				el.classList.remove('flagged')
				ref.child('data/'+key).set(combpath)

				letters.value = ''

				clr()
			}
		}

		ref.child('flags').on('child_added', updateFlag)
		ref.child('flags').on('child_removed', updateFlag)

		canvas.addEventListener('mousedown', onMouseDown)
		window.addEventListener('mousemove', onMouseMove)
		window.addEventListener('mouseup', onMouseUp)
	</script>
</body>
</html>